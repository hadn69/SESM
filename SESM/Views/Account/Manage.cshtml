@model SESM.Models.Views.Account.ManageViewModel
@{
    ViewBag.Title = "Manage Account";


    List<KeyValuePair<string, string>> breadCrumb = new List<KeyValuePair<string, string>>();
    breadCrumb.Add(new KeyValuePair<string, string>("Manage Account", "/Account/Manage/"));
    ViewBag.Breadcrumb = breadCrumb;
}
<script src="/Content/Js/md5-min.js" type="text/javascript"></script>
<div class="portlet light bordered">
    <div class="portlet-body form">
        <!-- BEGIN FORM-->
        <form action="#" class="form-horizontal">
            <div class="form-body">
                <div class="form-group">
                    <label class="col-md-3 control-label">Username</label>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" class="form-control" placeholder="UserName" id="inpUsername">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">Email Address</label>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-envelope"></i>
                            </span>
                            <input type="email" class="form-control" placeholder="Email Address" id="inpEMail">
                        </div>
                    </div>
                </div>
                <h3 class="form-section">Change Password</h3>
                <div class="form-group">
                    <label class="col-md-3 control-label">Current Password</label>
                    <div class="col-md-4">
                        <input type="password" class="form-control" placeholder="Current Password" id="inpOldPassword">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">New Password</label>
                    <div class="col-md-4">
                        <input type="password" class="form-control" placeholder="New Password" id="inpNewPassword1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">Re-Type New Password</label>
                    <div class="col-md-4">
                        <input type="password" class="form-control" placeholder="Re-Type New Password" id="inpNewPassword2">
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <div class="row">
                    <div class="col-md-offset-3 col-md-9">
                        <button type="button" class="btn blue" id="btnUpdate">Update</button>
                        <button type="button" class="btn default" id="btnReset">Reset</button>
                    </div>
                </div>
            </div>
        </form>
        <!-- END FORM-->
    </div>
</div>

<script type="text/javascript">
    function initPage() {
        var defUsername = "";
        var defEMail = "";
        $("#btnReset").click(function () {
            $("#inpUsername").val(defUsername);
            $("#inpEMail").val(defEMail);
        });

        $.post("/API/Account/GetDetails",
            {},
            function (data, status) {
                if (status != "success") {
                    toastr.error("See console for more infos", "Fatal Error");
                    Console.warn("Fail authenticating : ");
                    Console.warn("Status : " + status);
                    Console.warn("Data : " + data);
                    return;
                }
                var xmlDoc = $.parseXML(data);
                var xmlObj = $(xmlDoc);
                var root = xmlObj.find("Response");

                if (root.children("Type").text() == "Error") {
                    toastr.error(root.children("Content").text(), "Error " + root.children("ReturnCode").text());
                    return;
                }

                defUsername = root.children("Content").children("Login").text();
                defEMail = root.children("Content").children("Email").text();

                $("#inpUsername").val(defUsername);
                $("#inpEMail").val(defEMail);
            });

        $("#btnUpdate").click(function () {
            $("#btnUpdate").prop('disabled', true);
            var postData = {
                Login: $("#inpUsername").val(),
                Email: $("#inpEMail").val()
            }
            if ($("#inpOldPassword").val() != "") {
                if ($("#inpNewPassword1").val() != $("#inpNewPassword2").val()) {
                    return;
                }
                postData.OldPassword = CryptoJS.MD5($("#inpOldPassword").val()).toString();
                postData.NewPassword = CryptoJS.MD5($("#inpNewPassword1").val()).toString();
            }

            $.post("/API/Account/SetDetails",
                postData,
            function (data, status) {
                $("#btnUpdate").prop('disabled', false);
                if (status != "success") {
                    toastr.error("See console for more infos", "Fatal Error");
                    Console.warn("Fail authenticating : ");
                    Console.warn("Status : " + status);
                    Console.warn("Data : " + data);
                    return;
                }
                var xmlDoc = $.parseXML(data);
                var xmlObj = $(xmlDoc);
                var root = xmlObj.find("Response");

                if (root.children("Type").text() == "Error") {
                    toastr.error(root.children("Content").text(), "Error " + root.children("ReturnCode").text());
                    return;
                }

                toastr.success("Your profile has been updated", "Profile Updated");
                defUsername = $("#inpUsername").val();
                defEMail = $("#inpEMail").val();
                $(".username").html(defUsername + " &nbsp;&nbsp;");
                $("#inpOldPassword").val("");
                $("#inpNewPassword1").val("");
                $("#inpNewPassword2").val("");
            });
        });
    }

</script>
